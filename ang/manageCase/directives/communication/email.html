<div ng-if="emailActivities.length > 0">
    <div class="crm-accordion-wrapper spc__accordion spc--header-white spc--size-little">
        <div class="crm-accordion-header crm-master-accordion-header">
            <span>Email Messages {{'(' + emailActivities['length'] + ')'}}:</span>
        </div>
        <div class="crm-accordion-body">
            <div class="spc__accordion-body-wrap spc--padding-right-20">
                <div>
                    <div data-activity-id="{{activity.id}}" ng-repeat="activity in emailActivities"
                         ng-class="{'com__email-activity-is-read' : activity['view_mode']['isRead']}"
                         class="com__email-activity crm-accordion-wrapper spc__accordion spc--header-white spc--size-little">
                        <ng-form name="activityEmailForm">
                            <div class="crm-accordion-header crm-master-accordion-header">
                                <div class="com__email-item-accordion-head">
                                    <div>From: {{activity.view_mode.from_contact.email_label}}</div>
                                    <div>{{formatDateAndTime(activity.view_mode.date_time, true)}}</div>
                                </div>
                            </div>
                            <div class="crm-accordion-body">
                                <div class="spc__accordion-body-wrap spc--padding-right-20">
                                    <table class="crm-entity spc__table spc--no-border crm-search-results">
                                        <tbody>
                                        <tr class="com__meta spc--table-grey-row" ng-show="currentReplyId != activity.id">
                                            <td class="spc--width-100 spc--padding-bottom-5 spc--padding-top-10 spc--vertical-align-middle">From:</td>
                                            <td class="spc--padding-bottom-5 spc--padding-top-10 spc--max-width-500">{{activity.view_mode.from_contact.email_label}}</td>
                                            <td class="com__meta_action spc--padding-bottom-5 spc--padding-top-10">
                                                <button class="spc__button spc--height-little" ng-click="toggleReadEmail(activity.id, true)" ng-show="!activity.view_mode.isRead">
                                                    <span class="ui-button-icon ui-icon fa-eye"></span>
                                                    <span class="ui-button-icon-space"> </span>
                                                    <span>Mark as read</span>
                                                </button>
                                                <button class="spc__button spc--height-little" ng-click="toggleReadEmail(activity.id, false)" ng-show="activity.view_mode.isRead">
                                                    <span class="ui-button-icon ui-icon fa-eye-slash"></span>
                                                    <span class="ui-button-icon-space"> </span>
                                                    <span>Mark as unread</span>
                                                </button>
                                                <button class="spc__button spc--height-little" ng-click="reply(activity.id)" ng-show="currentReplyId != activity.id">
                                                    <span class="ui-button-icon ui-icon fa-reply"></span>
                                                    <span class="ui-button-icon-space"> </span>
                                                    <span>Reply</span>
                                                </button>
                                                <button class="spc__button spc--height-little" ng-click="forward(activity.id)" ng-show="currentReplyId != activity.id">
                                                    <span class="ui-button-icon ui-icon fa-share"></span>
                                                    <span class="ui-button-icon-space"> </span>
                                                    <span>Forward</span>
                                                </button>
                                            </td>
                                        </tr>
                                        <tr class="com__meta spc--table-grey-row" ng-show="currentReplyId != activity.id">
                                            <td class="spc--width-100 spc--padding-bottom-10 spc--padding-top-5 spc--vertical-align-middle">To:</td>
                                            <td class="spc--padding-bottom-10 spc--padding-top-5 spc--max-width-500">{{activity.view_mode.to_contacts_email_label}}</td>
                                            <td class="com__meta_action spc--padding-bottom-10 spc--padding-top-5">
                                                <div class="com__message-toggle-height-to-full">
                                                    <button class=" spc__button spc--height-little" ng-click="toggleHeight(activity.id)">
                                                        <span class="ui-button-icon ui-icon fa-expand"></span>
                                                        <span class="ui-button-icon-space"> </span>
                                                        <span>To full email body</span>
                                                    </button>
                                                </div>
                                                <div class="com__message-toggle-height-to-part">
                                                    <button class=" spc__button spc--height-little" ng-click="toggleHeight(activity.id)">
                                                        <span class="ui-button-icon ui-icon fa-compress"></span>
                                                        <span class="ui-button-icon-space"> </span>
                                                        <span>Show part email body</span>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                        <tr class="com__meta spc--table-grey-row" ng-show="currentReplyId != activity.id">
                                            <td class="spc--padding-bottom-5 spc--padding-top-5 spc--width-100 spc--vertical-align-middle">Subject:</td>
                                            <td class="spc--padding-bottom-5 spc--padding-top-5 spc--max-width-500">{{activity.view_mode.subject}}</td>
                                            <td class="com__email_date spc--padding-bottom-5 spc--padding-top-5">
                                                {{formatDateAndTime(activity.view_mode.date_time, true)}}
                                            </td>
                                        </tr>
                                        <tr class="com__meta spc--table-grey-row" ng-show="currentReplyId != activity.id && activity.view_mode.attachments.length > 0">
                                            <td class="spc--width-100 spc--padding-bottom-10 spc--padding-top-10 spc--vertical-align-middle">Attachments:</td>
                                            <td class="spc--padding-bottom-10 spc--padding-top-10" colspan="2">
                                                <ul class="com__attachments">
                                                    <li ng-repeat="attachment in activity.view_mode.attachments">
                                                        <a href="{{attachment.url}}">
                                                            <i class="crm-i {{attachment.icon}}"></i> {{attachment.name}}
                                                        </a>
                                                    </li>
                                                </ul>
                                            </td>
                                        </tr>
                                        <tr class="com__message spc--no-border spc--padding-bottom-10 spc--padding-top-10" ng-if="currentReplyId != activity.id">
                                            <td colspan="3" class="spc--padding-0">
                                                <div class="com__message-body">
                                                    <div ng-bind-html="activity.view_mode.emailBodyResolved"></div>
                                                </div>
                                            </td>
                                        </tr>

                                        <tr class="com__reply spc--no-border" ng-if="replyMode == 'reply' && currentReplyId == activity.reply_mode.id">
                                            <td crm-ui-id-scope colspan="3" class="spc--padding-0 spc--padding-bottom-10 spc--padding-top-10">
                                                <div>
                                                    <table class="crm-entity com__reply-table spc__table crm-search-results spc--no-margin" >
                                                        <tbody>
                                                        <tr class="com__meta spc--table-grey-row spc--no-border">
                                                            <td class="spc--width-100 spc--padding-bottom-5 spc--padding-top-10 spc--vertical-align-middle">From:</td>
                                                            <td class="spc--padding-bottom-5 spc--padding-top-10">
                                                                <div>
                                                                    <select-email is-required="true" is-multiple="false" max-width="600" model="activity.reply_mode.emails.from"></select-email>
                                                                </div>
                                                            </td>
                                                        </tr>
                                                        <tr class="com__meta spc--table-grey-row spc--no-border">
                                                            <td class="spc--width-100 spc--padding-bottom-5 spc--padding-top-0 spc--vertical-align-middle">To:</td>
                                                            <td class="spc--padding-bottom-5 spc--padding-top-0">
                                                                <div>
                                                                    <select-email is-required="true" is-multiple="true" max-width="600" model="activity.reply_mode.emails.to"></select-email>
                                                                </div>
                                                            </td>
                                                        </tr>
                                                        <tr class="com__meta spc--table-grey-row spc--no-border">
                                                            <td class="spc--width-100 spc--padding-bottom-5 spc--padding-top-0 spc--vertical-align-middle">CC:</td>
                                                            <td class="spc--padding-bottom-5 spc--padding-top-0">
                                                                <div>
                                                                    <select-email is-required="false" is-multiple="true" max-width="600" model="activity.reply_mode.emails.cc"></select-email>
                                                                </div>
                                                            </td>
                                                        </tr>
                                                        <tr class="com__meta spc--table-grey-row spc--no-border">
                                                            <td class="spc--width-100 spc--padding-bottom-10 spc--padding-top-0 spc--vertical-align-middle">
                                                                <label for="{{'reply' + subject + activity.reply_mode.id}}">Subject:</label>
                                                            </td>
                                                            <td class="spc--padding-bottom-10 spc--padding-top-0">
                                                                <div class="com__edit-subject-input-wrap">
                                                                    <input id="{{'reply' + subject + activity.reply_mode.id}}" name="subject"
                                                                           class="spc__input spc--width-100-percent" ng-model="activity.reply_mode.subject" type="text" ng-required="true">
                                                                </div>
                                                            </td>
                                                        </tr>
                                                        </tbody>
                                                    </table>
                                                    <div class="com__reply-edit-area">
                                                        <div class="com__templates">
                                                            <input class="spc__input spc--single-select" mailutils-template on-select="$broadcast('insert:reply', token.name)" tabindex="-1" style="z-index:1">
                                                        </div>
                                                        <textarea crm-ui-id="email-reply-{{activity.reply_mode.id}}" crm-ui-richtext crm-ui-insert-rx="insert:reply"
                                                                  name="reply" ng-model="activity.reply_mode.email_body"
                                                                  style="height: 500px" data-preset="civimail"></textarea>
                                                    </div>
                                                    <spc-attachment model="activity.reply_mode.additionalAttachments" ></spc-attachment>
                                                </div>
                                            </td>
                                        </tr>

                                        <tr class="com__reply spc--no-border" ng-if="replyMode == 'forward' && currentReplyId == activity.forward_mode.id">
                                            <td crm-ui-id-scope colspan="3" class="spc--padding-0 spc--padding-bottom-10 spc--padding-top-10">
                                                <div>
                                                    <table class="crm-entity com__reply-table spc__table crm-search-results spc--no-margin" >
                                                        <tbody>
                                                        <tr class="com__meta spc--table-grey-row spc--no-border">
                                                            <td class="spc--width-100 spc--padding-bottom-5 spc--padding-top-10 spc--vertical-align-middle">From:</td>
                                                            <td class="spc--padding-bottom-5 spc--padding-top-10">
                                                                <div>
                                                                    <select-email is-required="true" is-multiple="false" max-width="600" model="activity.forward_mode.emails.from"></select-email>
                                                                </div>
                                                            </td>
                                                        </tr>
                                                        <tr class="com__meta spc--table-grey-row spc--no-border">
                                                            <td class="spc--width-100 spc--padding-bottom-5 spc--padding-top-0 spc--vertical-align-middle">To:</td>
                                                            <td class="spc--padding-bottom-5 spc--padding-top-0">
                                                                <div>
                                                                    <select-email is-required="true" is-multiple="true" max-width="600" model="activity.forward_mode.emails.to"></select-email>
                                                                </div>
                                                            </td>
                                                        </tr>
                                                        <tr class="com__meta spc--table-grey-row spc--no-border">
                                                            <td class="spc--width-100 spc--padding-bottom-5 spc--padding-top-0 spc--vertical-align-middle">CC:</td>
                                                            <td class="spc--padding-bottom-5 spc--padding-top-0">
                                                                <div>
                                                                    <select-email is-required="false" is-multiple="true" max-width="600" model="activity.forward_mode.emails.cc"></select-email>
                                                                </div>
                                                            </td>
                                                        </tr>
                                                        <tr class="com__meta spc--table-grey-row spc--no-border">
                                                            <td class="spc--width-100 spc--padding-bottom-10 spc--padding-top-0 spc--vertical-align-middle">
                                                                <label for="{{'forward' + subject + activity.forward_mode.id}}">Subject:</label>
                                                            </td>
                                                            <td class="spc--padding-bottom-5 spc--padding-top-0">
                                                                <div class="com__edit-subject-input-wrap">
                                                                    <input id="{{'forward' + subject + activity.forward_mode.id}}" name="subject" class="spc__input spc--width-100-percent" ng-model="activity.forward_mode.subject" type="text" ng-required="true">
                                                                </div>
                                                            </td>
                                                        </tr>
                                                        <tr class="com__meta spc--table-grey-row" ng-show="activity.forward_mode.attachments.length > 0">
                                                            <td class="spc--width-100 spc--padding-bottom-10 spc--padding-top-5 spc--vertical-align-middle">Attachments:</td>
                                                            <td class="spc--padding-bottom-10 spc--padding-top-5" colspan="2">
                                                                <ul class="com__attachments com__attachments-flex">
                                                                    <li class="com__attachment-item" ng-repeat="attachment in activity.forward_mode.attachments">
                                                                        <div class="com__attachment-item-link">
                                                                            <a href="{{attachment.url}}">
                                                                                <i class="crm-i {{attachment.icon}}"></i> {{attachment.name}}
                                                                            </a>
                                                                        </div>
                                                                        <div class="com__attachment-item-delete" ng-click="removeForwardAttachment(attachment.file_id, activity.forward_mode)" title="delete">delete</div>
                                                                    </li>
                                                                </ul>
                                                            </td>
                                                        </tr>
                                                        </tbody>
                                                    </table>
                                                    <div class="com__reply-edit-area">
                                                        <div class="com__templates">
                                                            <input class="spc__input spc--single-select" mailutils-template on-select="$broadcast('insert:reply', token.name)" tabindex="-1" style="z-index:1">
                                                        </div>
                                                        <textarea crm-ui-id="email-forward-{{activity.forward_mode.id}}" crm-ui-richtext crm-ui-insert-rx="insert:reply"
                                                                  name="reply" ng-model="activity.forward_mode.email_body" style="height: 500px" data-preset="civimail"></textarea>
                                                    </div>
                                                    <spc-attachment model="activity.forward_mode.additionalAttachments" ></spc-attachment>
                                                </div>
                                            </td>
                                        </tr>

                                        <tr class="spc--padding-0 spc--no-border">
                                            <td class="spc--padding-0 spc--no-border">
                                                <div class="com__errors-wrap"></div>
                                            </td>
                                        </tr>

                                        <tr class="spc--padding-0 spc--no-border">
                                            <td class="spc--padding-0" colspan="3">
                                                <div class="com__message-buttons">
                                                    <button class="spc__button spc--height-medium" ng-click="reply(activity.id)" ng-show="currentReplyId != activity.id">
                                                        <span class="ui-button-icon ui-icon fa-reply"></span>
                                                        <span class="ui-button-icon-space"> </span>
                                                        <span>Reply</span>
                                                    </button>
                                                    <button class="spc__button spc--height-medium" ng-click="forward(activity.id)" ng-show="currentReplyId != activity.id">
                                                        <span class="ui-button-icon ui-icon fa-share"></span>
                                                        <span class="ui-button-icon-space"> </span>
                                                        <span>Forward</span>
                                                    </button>
                                                    <button class="spc__button spc--height-medium" ng-disabled="activityEmailForm.$invalid" ng-click="send(activity)"
                                                            ng-show="currentReplyId == activity.id">
                                                        <span class="ui-button-icon ui-icon fa-paper-plane-o"></span>
                                                        <span class="ui-button-icon-space"> </span>
                                                        <span>Send</span>
                                                    </button>
                                                    <button class="spc__button spc--height-medium button__cancel" ng-click="cancel()" ng-show="currentReplyId == activity.id">Cancel</button>
                                                </div>
                                            </td>
                                        </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </ng-form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
